<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div id="slideshow"></div>

    <!-- For style testing on desktop and mobile) -->
    <!-- <video autoplay muted controls src='./assets-cities/1.mp4'></video> -->
    <!-- <video autoplay muted controls src='./assets-cities/2.mp4'></video> -->

    <script type="module">
        const $ = document.querySelector.bind(document);
        const $$ = document.querySelectorAll.bind(document); // optional for multiple elements

        import { preloadImage, sleep, playVideo, addGoToFullscreenButton, showNeedsUserGestureToEnableAudio, playAudio, waitSync } from "./utils.js";

        showNeedsUserGestureToEnableAudio();


        const isProd = location.hostname === 'sahilrajput.com';

        // Images - https://www.pexels.com/search/big%20size/
        // Videos - https://www.pexels.com/video
        const slides = [
            {
                image: "https://images.pexels.com/photos/378570/pexels-photo-378570.jpeg",
                duration: 3000, // Note: Length of audio overrides this duration.
                audio: !isProd ? './asset-audios/img-1-description.mp3' : "https://files.mypot.in/slideshow-assets/cities/img-1-description.mp3"
            },
            {
                video: !isProd ? './asset-videos/3-with-sound.mp4' : "https://files.mypot.in/slideshow-assets/cities/3-with-sound.mp4",
                duration: null // videos play as long as they have not ended
            },
            {
                video: !isProd ? './asset-videos/1.mp4' : "https://files.mypot.in/slideshow-assets/cities/1.mp4",
                // video: "https://github.com/RagaTime/ragatime-files/blob/main/slideshow-assets/cities/1.mp4?raw=true",
                duration: null // videos play as long as they have not ended
            },
            {
                image: "https://images.pexels.com/photos/460672/pexels-photo-460672.jpeg",
                duration: 3000
            },
            {
                video: !isProd ? './asset-videos/2.mp4' : "https://files.mypot.in/slideshow-assets/cities/2.mp4",
                duration: null // videos play as long as they have not ended
            },
            {
                image: "https://images.pexels.com/photos/1388069/pexels-photo-1388069.jpeg",
                duration: 3000
            },
            {
                image: "https://images.pexels.com/photos/672532/pexels-photo-672532.jpeg",
                duration: 3000
            }
        ];

        main();
        async function main() {
            // ! Only for debugging..
            // await sleep(3_000);

            // Preload images
            for (const i in slides) { if (slides[i].image) { slides[i].image = await preloadImage(slides[i].image); } }
            // Learn: Use below statement to parallely load images
            // const loadedImgs = await Promise.all(slides.map(s => s.image).map(preloadImage)); for (const i in slides) { slides[i].image = loadedImgs[i]; }
            // console.log("üöÄ ~ loadedImgs:", loadedImgs);
            console.log("All images loaded ‚úÖ", slides.map(s => s.image));
            const container = $("#slideshow");
            let current = 0;
            const defaultDelay = 4000;
            let paused = false;

            // Create control buttons
            const controls = document.createElement("div");
            controls.className = 'slideshow-controls-container';
            controls.innerHTML = `
            <div></div>
            <div style="display: flex;">
                <button id="restartBtn">‚èÆÔ∏è</button>
                <button id="prevBtn">‚¨ÖÔ∏è</button>
                <button id="pauseBtn">‚è∏Ô∏è</button>
                <button id="nextBtn">‚û°Ô∏è</button>
                <div class="goToFullscreenContainer"><button id="goToFullscreen">‚õ∂</button></div>
            </div>
            <div><span id="slideCounter">1</span>/<span id="slideCounterTotal">1</span></div>
    `;
            document.body.prepend(controls);
            // This can only be done after fullscreen element has been aded to dom.
            addGoToFullscreenButton();
            // This can only be done after slideCounterTotal element has been aded to dom.
            $('#slideCounterTotal').innerHTML = slides.length;

            const updatePauseBtnLabel = () => pauseBtn.textContent = paused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
            async function setSlide(_current) {
                paused = true;
                // Stop awaiting of already playing audio or video
                window.finishPlaybacOfAlreadyPlayingVideo?.();
                window.finishPlaybacOfAlreadyPlayingAudio?.();
                window.resolveSleep?.(); // To resolve any currently running `await sleep(..)` immediately.
                await waitSync(() => isWhileLoopInPausedBlock);
                console.log("üöÄ ~ setSlide - current=_current:", _current);
                current = _current;
                paused = false;     // start the while loop again
                statusOfPauseBtn = false;
                updatePauseBtnLabel();
            }

            // Learn: When current video is finished and we're paused: we do not change the index.
            const getNextSlideIndex = () => (current + (isWhileLoopInPausedBlock ? 0 : 1)) % slides.length;

            // Learn: When current video is finished and we're paused: we decrement slideIndex by 2 to back to last to last slide becaue the `current` has changed to `nextSlideIndex` already.
            const getPreviousSlideIndex = () => (current - (isWhileLoopInPausedBlock ? 2 : 1) + slides.length) % slides.length;

            // Event handlers
            $('#restartBtn').addEventListener('click', () => { setSlide(0); });
            $("#prevBtn").addEventListener("click", () => { setSlide(getPreviousSlideIndex()); });
            $("#nextBtn").addEventListener("click", () => { setSlide(getNextSlideIndex()); });
            var statusOfPauseBtn = false; // initial status of pause button
            $("#pauseBtn").addEventListener("click", async () => {
                if (statusOfPauseBtn !== paused) {
                    // Sync pause button status if they not in sync
                    statusOfPauseBtn = paused;
                    updatePauseBtnLabel();
                    return;
                }
                console.log('paused-before?', paused);
                paused = !paused;
                statusOfPauseBtn = paused;
                console.log('paused-after?', paused);
                updatePauseBtnLabel();
            });


            // Function to display slide
            async function showSlide() {
                $('#slideCounter').innerHTML = current + 1;
                console.log("üöÄ ~ showSlide - current:", current);
                container.innerHTML = "";   // remove previous image
                const slide = slides[current];
                if (slide.image) {
                    container.appendChild(slide.image);
                    if (slide.audio) {
                        const audio = document.createElement('audio');
                        audio.src = slide.audio;
                        audio.controls = true; // show/hide controls
                        container.appendChild(audio);
                        console.log('play-audio-before');
                        const result = await playAudio(audio);
                        console.log('play-audio-after ‚ù§Ô∏è');
                        // This is to keep image showing when there was no user-interaction leading to error in playing audio.
                        if (result?.error) { await sleep(defaultDelay); }
                    } else {
                        await sleep(slide.duration || defaultDelay);
                        console.log('‚ù§Ô∏èimage sleep finished now!!');
                    }
                } else if (slide.video) {
                    const video = document.createElement("video");
                    video.src = slide.video;
                    // Note: If user has not interacted the video does NOT play at all when `muted: false` so we must play video without audio when user has not yet interacted.
                    Object.assign(video, { autoplay: true, muted: userInteracted ? false : true, controls: true });
                    container.appendChild(video);
                    await playVideo(video); // wait until video finishes
                }
            }
            // Loop through slides
            while (true) {
                var isWhileLoopInPausedBlock = paused;
                if (!paused) {
                    console.log('playing-slide');
                    await showSlide();
                    console.log('playing-slide- ‚úÖ');
                    current = (current + 1) % slides.length; // Learn: The modulo operator (%) wraps the index back to 0 when it reaches the end.
                } else {
                    console.log('üî¥while-loop-blocked');
                    await sleep(200); // small delay while paused
                }
            }
        }
    </script>

    <style>
        #slideshow {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #slideshow>img {
            width: 100%;
            max-height: 80vh;
        }

        #slideshow>video {
            width: 100%;
            max-height: 75vh;
        }

        #slideshow>audio {
            width: 100%;
            max-width: 450px;
            margin-top: 10px;
        }

        /* For quick testing of video sizes for images & videos */
        /* img {
            width: 100%;
            max-height: 80vh;
        }
        video {
            width: 100%;
            max-height: 90vh;
        } */


        .goToFullscreenContainer {
            display: flex;
            justify-content: center;
            /* margin-bottom: 15px; */
        }

        .slideshow-controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #restartBtn,
        #prevBtn,
        #pauseBtn,
        #nextBtn {
            padding: 5px 20px;
            border-radius: 5px;
            border-color: lightblue;
            outline: none;
            margin: 0 5px;
        }

        #goToFullscreen {
            padding: 5px 20px;
            border-radius: 5px;
            border-color: lightblue;
            outline: none;
        }

        div:has(#slideCounter) {
            text-align: end;
        }
    </style>
</body>

</html>